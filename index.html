<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ordefy - E-commerce Management Dashboard</title>
    <meta name="description" content="Professional e-commerce management platform. Manage orders, products, inventory, and analytics all in one place. Developed by Bright Idea." />
    <meta name="author" content="Bright Idea" />
    <meta name="theme-color" content="hsl(0, 0%, 98%)" />

    <!-- Shopify App Bridge (AGGRESSIVE LOAD) -->
    <script>
      (function() {
        console.log('üöÄ [SHOPIFY] === AGGRESSIVE APP BRIDGE LOADER ===');

        // ============================================================
        // STEP 1: Detect iframe - if true, FORCE LOAD everything
        // ============================================================
        const isInIframe = window.top !== window.self;
        console.log('üîç [SHOPIFY] In iframe:', isInIframe);

        if (!isInIframe) {
          console.log('üè† [SHOPIFY] Standalone mode - App Bridge disabled');
          return; // Exit early if not in iframe
        }

        console.log('ü™ü [SHOPIFY] IFRAME DETECTED - FORCE LOADING APP BRIDGE');

        // ============================================================
        // STEP 2: Set global embedded flag IMMEDIATELY
        // ============================================================
        window.__SHOPIFY_EMBEDDED__ = true;
        console.log('‚úÖ [SHOPIFY] window.__SHOPIFY_EMBEDDED__ = true');

        // ============================================================
        // STEP 3: Get shop/host from URL (if available)
        // ============================================================
        const urlParams = new URLSearchParams(window.location.search);
        const shop = urlParams.get('shop');
        const host = urlParams.get('host');
        const embedded = urlParams.get('embedded');

        console.log('üìã [SHOPIFY] URL params:', { shop, host, embedded });

        // ============================================================
        // STEP 4: Save to sessionStorage (for navigation)
        // ============================================================
        if (shop) {
          sessionStorage.setItem('shopify_shop', shop);
          console.log('üíæ [SHOPIFY] Saved shop to sessionStorage:', shop);
        }
        if (host) {
          sessionStorage.setItem('shopify_host', host);
          console.log('üíæ [SHOPIFY] Saved host to sessionStorage');
        }
        if (embedded) {
          sessionStorage.setItem('shopify_embedded', embedded);
          console.log('üíæ [SHOPIFY] Saved embedded to sessionStorage');
        }

        // ============================================================
        // STEP 5: Try to get from sessionStorage if not in URL
        // ============================================================
        const savedShop = shop || sessionStorage.getItem('shopify_shop');
        const savedHost = host || sessionStorage.getItem('shopify_host');

        console.log('üì¶ [SHOPIFY] SessionStorage values:', { savedShop, savedHost });

        // ============================================================
        // STEP 6: INJECT API KEY META TAG (UNCONDITIONAL)
        // ============================================================
        console.log('üîë [SHOPIFY] Injecting API key meta tag...');
        const apiKeyMeta = document.createElement('meta');
        apiKeyMeta.name = 'shopify-api-key';
        apiKeyMeta.content = '75123c29296179fbd8f253db4196c83b';
        document.head.appendChild(apiKeyMeta);
        console.log('‚úÖ [SHOPIFY] API key meta tag injected');

        // ============================================================
        // STEP 7: INJECT SHOP META TAG (if available)
        // ============================================================
        if (savedShop) {
          console.log('üè™ [SHOPIFY] Injecting shop meta tag:', savedShop);
          const shopMeta = document.createElement('meta');
          shopMeta.name = 'shopify-shop';
          shopMeta.content = savedShop;
          document.head.appendChild(shopMeta);
          console.log('‚úÖ [SHOPIFY] Shop meta tag injected');
        } else {
          console.warn('‚ö†Ô∏è  [SHOPIFY] No shop parameter available (yet)');
        }

        // ============================================================
        // STEP 8: INJECT HOST META TAG (if available)
        // ============================================================
        if (savedHost) {
          console.log('üåê [SHOPIFY] Injecting host meta tag');
          const hostMeta = document.createElement('meta');
          hostMeta.name = 'shopify-host';
          hostMeta.content = savedHost;
          document.head.appendChild(hostMeta);
          console.log('‚úÖ [SHOPIFY] Host meta tag injected');
        }

        // ============================================================
        // STEP 9: INJECT APP BRIDGE SCRIPT (UNCONDITIONAL & SYNCHRONOUS)
        // ============================================================
        console.log('üìú [SHOPIFY] FORCE LOADING APP BRIDGE SCRIPT...');
        const script = document.createElement('script');
        script.src = 'https://cdn.shopify.com/shopifycloud/app-bridge.js';
        script.async = false; // SYNCHRONOUS - blocks until loaded

        // ============================================================
        // CRITICAL: Add data attributes for App Bridge CDN auto-init
        // ============================================================
        script.setAttribute('data-api-key', '75123c29296179fbd8f253db4196c83b');
        console.log('‚úÖ [SHOPIFY] Added data-api-key attribute to script');

        if (savedHost) {
          script.setAttribute('data-host', savedHost);
          console.log('‚úÖ [SHOPIFY] Added data-host attribute to script:', savedHost);
        } else {
          console.warn('‚ö†Ô∏è  [SHOPIFY] No host available for data-host attribute');
        }

        if (savedShop) {
          script.setAttribute('data-shop', savedShop);
          console.log('‚úÖ [SHOPIFY] Added data-shop attribute to script:', savedShop);
        } else {
          console.warn('‚ö†Ô∏è  [SHOPIFY] No shop available for data-shop attribute');
        }

        script.onload = function() {
          console.log('‚úÖ [SHOPIFY] ===================================');
          console.log('‚úÖ [SHOPIFY] APP BRIDGE SCRIPT LOADED!');
          console.log('‚úÖ [SHOPIFY] window.shopify exists:', !!window.shopify);
          console.log('‚úÖ [SHOPIFY] window.shopify.createApp exists:', !!(window.shopify && window.shopify.createApp));
          console.log('‚úÖ [SHOPIFY] ===================================');
        };

        script.onerror = function(error) {
          console.error('‚ùå [SHOPIFY] ===================================');
          console.error('‚ùå [SHOPIFY] FAILED TO LOAD APP BRIDGE SCRIPT!');
          console.error('‚ùå [SHOPIFY] Error:', error);
          console.error('‚ùå [SHOPIFY] ===================================');
        };

        document.head.appendChild(script);
        console.log('‚úÖ [SHOPIFY] App Bridge <script> tag injected into <head>');
        console.log('üìã [SHOPIFY] Script attributes:', {
          'data-api-key': '***' + script.getAttribute('data-api-key').slice(-8),
          'data-host': script.getAttribute('data-host') || 'NOT SET',
          'data-shop': script.getAttribute('data-shop') || 'NOT SET'
        });

        // ============================================================
        // STEP 10: Verification
        // ============================================================
        console.log('üîç [SHOPIFY] === FINAL VERIFICATION ===');
        console.log('   ‚úÖ In iframe:', isInIframe);
        console.log('   ‚úÖ __SHOPIFY_EMBEDDED__:', window.__SHOPIFY_EMBEDDED__);
        console.log('   ‚úÖ Script injected: YES');
        console.log('   ‚úÖ API key meta tag: YES');
        console.log('   ‚úÖ Script data-api-key: YES');
        console.log('   üìã Script data-host:', script.getAttribute('data-host') ? 'YES' : '‚ùå MISSING');
        console.log('   üìã Script data-shop:', script.getAttribute('data-shop') ? 'YES' : '‚ö†Ô∏è  MISSING');
        console.log('   üìã Shop (sessionStorage):', savedShop || 'NOT AVAILABLE');
        console.log('   üìã Host (sessionStorage):', savedHost || 'NOT AVAILABLE');
        console.log('üîç [SHOPIFY] === END ===');
      })();
    </script>

    <!-- Prevent flash of unstyled content for dark mode -->
    <script>
      (function() {
        const theme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (theme === 'dark' || (!theme && prefersDark)) {
          document.documentElement.classList.add('dark');
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', 'hsl(240, 10%, 8%)');
        } else {
          document.documentElement.classList.add('light');
        }
      })();
    </script>

    <meta property="og:title" content="Ordefy - E-commerce Management Dashboard" />
    <meta property="og:description" content="Professional e-commerce management platform. Manage orders, products, inventory, and analytics all in one place." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://ordefy.io" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Ordefy - E-commerce Management Dashboard" />
    <meta name="twitter:description" content="Professional e-commerce management platform by Bright Idea" />
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
